/*---------------------------------------------------------------------------------------------------
ソフトウェア実習のためのarduino受信制御のソース

八尾ロボのソースを参考にしている
送られてくるデータがをパケットとして受信
チェックサムなどは省くこととする

一応スタートビットとエンドビットは取り付ける


入ってくる数値は0～615くらいの数値である

サーボモーターを動かすソースである
動かなかったサーボ　３つは電流が少し足りなかった模様
アイドルロボットで使用しているソースは無事に動いた

更新日時　2016/01/12
-------------------------------------------------------------------------------------------------------
*/
#include <stdlib.h>
#include <Servo.h> 

#define PWM 50

Servo servo;

void setup(){
	Serial.begin(9600);		//シリアルセットアップ

	servo.attach(9); 
	servo.write(90);
}


/*-----------------------------------------------------------------------------------------------
メインループ開始
-----------------------------------------------------------------------------------------------*/
void loop()
{
	servo.attach(9);


	
	//static = ループ内で変数を維持
//	long time;
	static uint32_t time;
	static uint32_t time2;
	static byte i = 0;				//配列用のカウント
	static byte serial_paket[12];	//パケットの収納場所
	char b;							//バイトの一時保存
	int flag = 	0;					//ただのフラグ
	int sum = 	0;					//チェックサムの計算
	int flag2 = 0;		
	int inum = 	0;					//ptrの結果収納
	char on_packet[2];				//パケットからチェックサムのデータの取り出し(一時的)

	int byte_sum = 0;
	static int pwm = 0;
	
//	time = millis();


	if(Serial.available()){
		
		b = Serial.read();				//b に一時保存
	//	Serial.write(b);
		if(b == ':')					//スタートビットを読み出し
		{
			i = 0;						//配列用の変数

	
		}
	
		serial_paket[i] = b;			//データを一列読み出す

		if(serial_paket[i] == '#' )		//すべてのデータ読み出し
		{
			flag = 1;					//パケット読み出し完了フラグ
			
		}

		i++;							//パケット読み出し用カウント

	}



	if(flag == 1)
	{
		for(int a=0; a<i; a++){		//一行分のデータをプリント（デバッグ用）
	//		Serial.write(serial_paket[a]);
	
		}

		on_packet[0] = serial_paket[1];	//チェックサムのデータの取り出し
		on_packet[1] = serial_paket[2];
		on_packet[2] = serial_paket[3];
		inum = atoi(on_packet);			//文字をつなげる
		
		
		
		inum = inum / 4;
		
		
		Serial.println(inum);				//文字列の取り出し
		

	
		flag = 0;
		i = 0;
		flag2 = 1;
	}

/*-----------------------------------------------------------------------------------------------
ここからモーターへの指示
-----------------------------------------------------------------------------------------------*/




	
/*	servo.write(90);
	delay(1000);
	servo.write(170);
	delay(1000);
*/	


	if(flag2 == 1)
	{
		servo.write(inum); 
/*

		
		if(inum < 300)
		{
			
			servo.write(0);
			Serial.println("F");

			
		}
		else if(inum > 400)
		{
			servo.write(170);      
			Serial.println("R");

			
		}
		else
		{
			
			servo.write(90); 
			Serial.println("OFF");
		
		}
		
*/	
	}



}
